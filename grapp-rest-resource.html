 
<!--
Copyright (c) 2014-2015 Dirk Grappendorf, www.grappendorf.net. All rights reserved.
This code may only be used under the MIT style license found in the file LICENSE.txt.

Element: grapp-rest-resource
Version: 0.1.9
Description: A web component that encapsulates REST API calls
-->


<link rel="import" href="../iron-ajax/iron-request.html">

<dom-module id="grapp-rest-resource">

<script type="text/javascript">(function() {
  Polymer({
    is: 'grapp-rest-resource',
    properties: {
      url: {
        type: String
      },
      params: {
        type: String,
        value: function() {
          return {};
        }
      },
      resource: {
        type: Object,
        notify: true
      },
      indexUrl: {
        type: String
      },
      showUrl: {
        type: String
      },
      newUrl: {
        type: String
      },
      createUrl: {
        type: String
      },
      updateUrl: {
        type: String
      },
      destroyUrl: {
        type: String
      },
      memberUrl: {
        type: String
      },
      headers: {
        type: Object,
        value: function() {
          return {};
        }
      },
      token: {
        type: String
      },
      request: {
        type: Object
      }
    },
    ready: function() {
      var self;
      self = this;
      return this.resource = {
        index: function() {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('GET', self.indexUrl).then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        },
        show: function(id) {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('GET', self.showUrl, id).then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        },
        "new": function() {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('GET', self.newUrl, null, 'new').then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        },
        create: function(data) {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('POST', self.createUrl, null, data).then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        },
        update: function(id, data) {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('PUT', self.updateUrl, id, data).then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        },
        destroy: function(id) {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('DELETE', self.destroyUrl, id).then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        },
        memberAction: function(id, action) {
          return new Promise(function(resolve, reject) {
            return self._sendRequest('PUT', self.memberUrl, id, action).then(function(request) {
              return self._handleResponse(request.response, request.xhr.status, resolve);
            }, function() {
              return self._handleError(self.request.xhr.response, self.request.xhr.status, reject);
            });
          });
        }
      };
    },
    _prepareUrl: function(url, params, id, action) {
      var name, value;
      if (typeof params === 'string') {
        params = JSON.parse(params);
      }
      for (name in params) {
        value = params[name];
        url = url.replace(":" + name, value);
      }
      url = url.replace(':id', id || '');
      url = url.replace(/\/\/+/g, '/');
      url = url.replace(/^(\w+):\//, '$1://');
      url = url.replace(/\/$/, '');
      if (action) {
        url += "/" + action;
      }
      return url;
    },
    _prepareHeaders: function() {
      var h, key, ref, val;
      h = {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      };
      ref = this.headers;
      for (key in ref) {
        val = ref[key];
        h[key] = val;
      }
      if (this.token) {
        h['Authorization'] = this.token;
      }
      return h;
    },
    _sendRequest: function(method, url, id, data, action) {
      if (id == null) {
        id = null;
      }
      if (data == null) {
        data = null;
      }
      if (action == null) {
        action = null;
      }
      this.request = this._createRequestElement();
      return this.request.send({
        method: method,
        url: this._prepareUrl(url || this.url, this.params, id, action),
        headers: this._prepareHeaders(),
        body: (data ? JSON.stringify(data) : void 0)
      });
    },
    _createRequestElement: function() {
      return document.createElement('iron-request');
    },
    _handleResponse: function(response, status, resolve) {
      var json;
      json = (response && response.trim() !== '' ? JSON.parse(response) : {});
      return resolve({
        data: json,
        status: status
      });
    },
    _handleError: function(response, status, reject) {
      var json;
      json = (response && response.trim() !== '' ? JSON.parse(response) : {});
      if (status === 401) {
        this.fire('grapp-authentication-error');
        return reject({
          data: json,
          status: status
        });
      } else {
        return reject({
          data: json,
          status: status
        });
      }
    }
  });

}).call(this);
</script>

</dom-module>
