 
<!--
Copyright (c) 2014-2015 Dirk Grappendorf, www.grappendorf.net. All rights reserved.
This code may only be used under the MIT style license found in the file LICENSE.txt.

Element: grapp-rest-resource
Version: 0.1.1
Description: A web component that encapsulates REST API calls
-->


<link href="../iron-ajax/iron-request.html" rel="import">

<dom-module id="grapp-rest-resource">

  <template>

    <iron-request id="request"></iron-request>

  </template>

<script type="text/javascript">(function() {
  Polymer({
    is: 'grapp-rest-resource',
    properties: {
      url: {
        type: String
      },
      params: {
        type: String,
        value: {}
      },
      resource: {
        type: Object,
        notify: true
      },
      indexUrl: {
        type: String
      },
      showUrl: {
        type: String
      },
      newUrl: {
        type: String
      },
      createUrl: {
        type: String
      },
      updateUrl: {
        type: String
      },
      destroyUrl: {
        type: String
      },
      memberUrl: {
        type: String
      },
      headers: {
        type: Object,
        value: {}
      },
      token: {
        type: String
      }
    },
    ready: function() {
      var self;
      self = this;
      return this.resource = {
        index: function(success, error) {
          return self._sendRequest('GET', self.indexUrl).then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        },
        show: function(id, success, error) {
          return self._sendRequest('GET', self.showUrl, id).then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        },
        "new": function(success, error) {
          return self._sendRequest('GET', self.newUrl, null, 'new').then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        },
        create: function(data, success, error) {
          return self._sendRequest('POST', self.createUrl, null, data).then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        },
        update: function(id, data, success, error) {
          return self._sendRequest('PUT', self.updateUrl, id, data).then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        },
        destroy: function(id, success, error) {
          return self._sendRequest('DELETE', self.destroyUrl, id).then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        },
        memberAction: function(id, action, success, error) {
          return self._sendRequest('PUT', self.memberUrl, id, action).then(function(request) {
            return self._handleResponse(request.response, request.xhr.status, success, error);
          });
        }
      };
    },
    _prepareUrl: function(url, params, id, action) {
      var name, value;
      if (typeof params === 'string') {
        params = JSON.parse(params);
      }
      for (name in params) {
        value = params[name];
        url = url.replace(":" + name, value);
      }
      url = url.replace(':id', id || '');
      url = url.replace(/\/\/+/g, '/');
      url = url.replace(/^(\w+):\//, '$1://');
      url = url.replace(/\/$/, '');
      if (action) {
        url += "/" + action;
      }
      return url;
    },
    _prepareHeaders: function() {
      var h, key, ref, val;
      h = {
        'Accept': 'application/json'
      };
      ref = this.headers;
      for (key in ref) {
        val = ref[key];
        h[key] = val;
      }
      if (this.token) {
        h['Authorization'] = this.token;
      }
      return h;
    },
    _sendRequest: function(method, url, id, data, action) {
      if (id == null) {
        id = null;
      }
      if (data == null) {
        data = null;
      }
      if (action == null) {
        action = null;
      }
      return this.$.request.send({
        method: method,
        url: this._prepareUrl(url || this.url, this.params, id, action),
        headers: this._prepareHeaders(),
        body: (data ? JSON.stringify(data) : void 0)
      });
    },
    _handleResponse: function(response, status, success, error) {
      var json;
      json = (response && response.trim() !== '' ? JSON.parse(response) : {});
      if (status >= 200 && status <= 299) {
        return typeof success === "function" ? success(json) : void 0;
      } else if (status === 401) {
        return self.fire('grapp-authentication-error');
      } else {
        return typeof error === "function" ? error(json) : void 0;
      }
    }
  });

}).call(this);
</script>

</dom-module>
