 
<!--
Copyright (c) 2014-2015 Dirk Grappendorf, www.grappendorf.net. All rights reserved.
This code may only be used under the MIT style license found in the file LICENSE.txt.

Element: grapp-rest-resource
Version: 0.0.10
Description: A web component that encapsulates REST API calls
-->


<link href="../iron-ajax/iron-request.html" rel="import">

<dom-module id="grapp-rest-resource">

  <template>

    <iron-request id="request"></iron-request>

  </template>

<script type="text/javascript">(function() {
  var prepareUrl;

  prepareUrl = function(url, params, id, action) {
    var name, value;
    if (params == null) {
      params = {};
    }
    if (id == null) {
      id = null;
    }
    if (action == null) {
      action = null;
    }
    if (typeof params === 'string') {
      params = JSON.parse(params);
    }
    for (name in params) {
      value = params[name];
      url = url.replace(":" + name, value);
    }
    url = url.replace(':id', id || '');
    url = url.replace(/\/\/+/g, '/');
    url = url.replace(/^(\w+):\//, '$1://');
    url = url.replace(/\/$/, '');
    if (action) {
      url += "/" + action;
    }
    return url;
  };

  Polymer({
    is: 'grapp-rest-resource',
    properties: {
      url: {
        type: String
      },
      params: {
        type: String
      },
      resource: {
        type: Object
      },
      indexUrl: {
        type: String
      },
      showUrl: {
        type: String
      },
      newUrl: {
        type: String
      },
      createUrl: {
        type: String
      },
      updateUrl: {
        type: String
      },
      destroyUrl: {
        type: String
      },
      memberUrl: {
        type: String
      },
      headers: {
        type: Object,
        value: {}
      },
      token: {
        type: String
      }
    },
    ready: function() {
      var self;
      self = this;
      return this.resource = {
        index: function(success, error) {
          return self.$.request.send({
            url: prepareUrl(self.indexUrl || self.url, self.params),
            headers: self.prepareHeaders()
          }).then(function(request) {
            var json;
            json = (request.response.trim() !== '' ? JSON.parse(request.response) : {});
            switch (request.xhr.status) {
              case 200:
                return typeof success === "function" ? success(json) : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error(json) : void 0;
            }
          });
        },
        show: function(id, success, error) {
          return self.$.request.send({
            url: prepareUrl(self.showUrl || self.url, self.params, id),
            headers: self.prepareHeaders()
          }).then(function(request) {
            var json;
            json = (request.response.trim() !== '' ? JSON.parse(request.response) : {});
            switch (request.xhr.status) {
              case 200:
                return typeof success === "function" ? success(json) : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error(json) : void 0;
            }
          });
        },
        "new": function(success, error) {
          return self.$.request.send({
            url: prepareUrl(self.newUrl || self.url, self.params, null, 'new'),
            headers: self.prepareHeaders()
          }).then(function(request) {
            var json;
            json = (request.response.trim() !== '' ? JSON.parse(request.response) : {});
            switch (request.xhr.status) {
              case 200:
                return typeof success === "function" ? success(json) : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error(json) : void 0;
            }
          });
        },
        create: function(data, success, error) {
          return self.$.request.send({
            method: 'POST',
            url: prepareUrl(self.createUrl || self.url, self.params),
            headers: self.prepareHeaders(),
            body: JSON.stringify(data)
          }).then(function(request) {
            var json;
            json = (request.response.trim() !== '' ? JSON.parse(request.response) : {});
            switch (request.xhr.status) {
              case 200:
              case 201:
              case 204:
                return typeof success === "function" ? success(json) : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error(json) : void 0;
            }
          });
        },
        update: function(id, data, success, error) {
          return self.$.request.send({
            method: 'PUT',
            url: prepareUrl(self.updateUrl || self.url, self.params, id),
            headers: self.prepareHeaders(),
            body: JSON.stringify(data)
          }).then(function(request) {
            var json;
            json = (request.response.trim() !== '' ? JSON.parse(request.response) : {});
            switch (request.xhr.status) {
              case 200:
              case 201:
              case 204:
                return typeof success === "function" ? success(json) : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error(json) : void 0;
            }
          });
        },
        destroy: function(id, success, error) {
          return self.$.request.send({
            method: 'DELETE',
            url: prepareUrl(self.destroyUrl || self.url, self.params, id),
            headers: self.prepareHeaders()
          }).then(function(request) {
            var json;
            json = (request.response.trim() !== '' ? JSON.parse(request.response) : {});
            switch (request.xhr.status) {
              case 200:
                return typeof success === "function" ? success(json) : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error(json) : void 0;
            }
          });
        },
        memberAction: function(id, action, success, error) {
          return self.$.request.send({
            method: 'PUT',
            url: prepareUrl(self.memberUrl || self.url, self.params, id, action),
            headers: self.prepareHeaders()
          }).then(function(request) {
            switch (request.xhr.status) {
              case 200:
                return typeof success === "function" ? success() : void 0;
              case 401:
                return self.fire('grapp-authentication-error');
              default:
                return typeof error === "function" ? error() : void 0;
            }
          });
        }
      };
    },
    prepareHeaders: function() {
      var h, key, ref, val;
      h = {
        'Accept': 'application/json'
      };
      ref = this.headers;
      for (key in ref) {
        val = ref[key];
        h[key] = val;
      }
      if (this.token) {
        h['Authorization'] = this.token;
      }
      return h;
    }
  });

}).call(this);
</script>

</dom-module>
